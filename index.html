<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet Screen Issue Resolver</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .issue-card {
            transition: all 0.2s ease-in-out;
        }
        .issue-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        /* Custom class for the Stripe category icon (No longer needed for SVG, but keeping the class for margin/padding) */
        .stripe-icon-svg {
            width: 1.5rem; /* Equivalent to w-6 */
            height: 1.5rem; /* Equivalent to h-6 */
        }
        /* Style for the AI Analysis section */
        #aiAnalysis {
            min-height: 8rem;
        }
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Lucide Icons -->
    <script type="module">
        // Added Nfc and removed DollarSign from direct imports (keeping DollarSign in iconMap for safety)
        import { createIcons, ChevronRight, ChevronLeft, Wifi, Signal, CreditCard, Monitor, AlertTriangle, Settings, Wrench, DollarSign, Nfc, Loader } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        
        // Expose the icon creation function and map globally for the main script.
        window.createIcons = createIcons; 
        
        // Include all imported icons in the map.
        // Added Nfc
        window.iconMap = { ChevronRight, ChevronLeft, Wifi, Signal, CreditCard, Monitor, AlertTriangle, Settings, Wrench, DollarSign, Nfc, Loader };

        createIcons({ icons: window.iconMap });
    </script>
</head>
<!-- UPDATED: Ensuring min-h-screen and responsive p-4 -->
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- UPDATED: Reduced default padding to p-4 for better mobile fit, kept lg:p-8 for desktop -->
    <div id="app" class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-4 lg:p-8">
        <!-- Header -->
        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i data-lucide="AlertTriangle" class="w-7 h-7 mr-2 text-red-500"></i>
                Cabinet Screen Issue Resolver
            </h1>
            <p class="text-gray-500 mt-1">Select the category of the problem you are currently dealing with.</p>
        </header>

        <!-- Main Content Area -->
        <div id="content">
            <!-- Content will be rendered here by JavaScript -->
        </div>
    </div>

    <script>
        // --- Gemini API Configuration ---
        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Placeholder for Canvas environment
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${API_KEY}`;

        // Utility for fetching with exponential backoff
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    console.log(`Request failed, retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // --- Data Parsing and Structure ---

        // The raw data from the uploaded document, manually cleaned up for parsing.
        const rawData = `
            The 2/3G SIM connection sign in the upper left side is not showing,1)The SIM is not working:,"-Check APN password: iot.indetel.net, or",-Check cabinet screen Settings: ,Roaming = on
            Wifi connection shows only 2 bars,,This signal is too weak to have a stable connection. Change to WIFI or SIM.
            Failure notice: “Offline”,There is a Bajie Restart in progress. Wait 5 minutes.
            There is no Stripe sign visible in the upper left side of the cabinet screen. There is no failure message.,There is a problem with the connection to the stripe device or with the software. ,"Option 1)check if the Internet connection has at least 3 stripes in “Badji/Upload machine screenshots/download machines screenshots”, if not, change to WIFI or SIM via Mouse or Airdroid",Option 2)restart in Badji,Option 3)reboot in Airdroid,Option 4)unplug/plug the cabinet cable 10 seconds,Option 5)reconnect the cable to the stripe device,Option 6)Take out the Stripe device and reset the stripe device by pressing a small skewer in the small hole on the side.,
            Red Stripe sign in the upper left side of the screen. There is no failure message + no logs in Cabinet Log since failure.,"Option 1)check if the Internet connection has at least 3 stripes in “Badji/Upload machine screenshots/download machines screenshots”, if not, change to WIFI or SIM via Mouse or Airdroid",Option 2)restart in Badji,Option 3)reboot in Airdroid,Option 4)unplug/plug the cabinet cable 10 seconds,Option 5)reconnect the cable to the stripe device,Option 6)Take out the Stripe device and reset the stripe device by pressing a small skewer in the small hole on the side.
            Failure notice: “discoverReaders onFailure;USB unexpectedly disconnected during operation:READER_ERROR.USB_DISCONNECTED”,"Doublecheck in “Badji/Upload machine screenshots/download machines screenshots”, Then reconnect the cable of the Stripe payment unit by visiting the venue."
            Failure notice: “dicover readers on success”,Option 1)restart via Airdroid,Option 2)Take out the Stripe device and reset the stripe device by pressing a small skewer in the small hole on the side.
            Failure notice: “Stripe pos reconnection failed”,Option 1)doublecheck in “Badji/Upload machine screenshots/download machines screenshots”. If confirmed:,Option 2)restart via Airdroid,"Option 3)unplug/plug the cabinet cable 10 seconds, or",Option 4)Take out the Stripe device and reset the stripe device by pressing a small skewer in the small hole on the side.
            Failure notice: “Powerbanks in this station are currently recharging and unavailable for use”,The powerbanks are not available due to battery levels lower than 33%.,Option 1)doublecheck in “Badji/Upload machine screenshots/download machines screenshots”. If confirmed:,Option 2)check the slots in Badji to doublecheck wether the battery levels are low. ,Option 3)restart in Badji and report issue
            Failure notice: “merchant Location ID no entry” or “Merchant Stripe Location Id is empty”,Option 1)doublecheck in “Badji/Upload machine screenshots/download machines screenshots”. If confirmed:,Option 2) Connect the Location ID of Stripe to the Merchant in Bajie and restart
            One of the moduls (layers) is not lighting up.,There is a problem with the cabels within the machine.,"Option 1) Remove 2 screws at the back midle side of the cabinet (8-slots). Shift the module slightly back and forwards. Then build everything together again, or",Option 2) Replace the machine for repair
            Cabinet screen shows wrong screen or switches back and forth between wrong and correct screen. Internet and Stripe signs show correctly.,Option 1)doublecheck in “Badji/Upload machine screenshots/download machines screenshots”. If confirmed:,"Option 2) go to the Advertising settings, doublecheck screen layout, select the correct screen, (see 1.4) and Publish, or",Option 3) Go to Ads manage/Publish Log/search the cabinet number Select the cabinet number and click “batch delete”.
            Cabinet screen shows black screen while Internet and Stripe signs show correctly.,"Option 1) go to the Advertising settings, doublecheck screen layout, select the correct screen, (see 1.4) and Publish, or",Option 2) Go to Ads manage/Publish Log/search the cabinet number Sekect the cabinet number and click “batch delete”.
            Cabinet screen is upside down,Option 1)doublecheck in “Badji/Upload machine screenshots/download machines screenshots”. If confirmed:,Option 2)Go to the screen settings (with mouse or via Airdroid) Settings/Auxiliary function/ set screen rotation to 270. Restart the Cabinet in Bajie or unplug/plug the cable.
            Failure notice: “Query device update information”,Option 1)doublecheck in “Badji/Upload machine screenshots/download machines screenshots”. If confirmed:,"Option 2)Check wether connection has at least 3 stripes. If not, switch to WIFI or Sim.",Option 3)Take out the Stripe device and reset the stripe device by pressing a small skewer in the small hole on the side.
            Failure notice: “Incorrect access path”,"Check if the number of slots is the same as the number of slots in Baji. If not, correct."
            Failure notice: “connecting to the register server”,"Check if the number of slots is the same as the number of slots in Baji. If not, correct."
            The screen is showing the Admin screen.,,There is a software problem. ,Option 1)use mouse or Airdroid: go to Settings/App&Notification/Revive. Click “Force stop”.,Go again to Settings/App&Notification/Revive. Click “Start”.,Option 2)use mouse: go to Settings and search “factory”. Initiate a factory restart. Re-enter SIM APN settings. Use a USB stick to upload Revive and Airdroid.
        `;

        // Helper function to clean up the raw text and split into issues/solutions
        function parseIssues(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const issues = [];

            lines.forEach(line => {
                // Simple attempt to split based on the first comma or a quoted phrase followed by a comma
                const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(p => p.replace(/^"|"$/g, '').trim()).filter(p => p.length > 0);

                if (parts.length >= 2) {
                    const issue = parts[0];
                    // Join the remaining parts as the solution
                    const solution = parts.slice(1).join(', ').replace(/\s{2,}/g, ' ').trim();

                    if (issue && solution) {
                        issues.push({ issue, solution });
                    }
                }
            });
            return issues;
        }

        const ALL_ISSUES = parseIssues(rawData);

        // Define categories and assign issues to them
        const CATEGORIES = [
            { id: 'network', name: 'SIM / Network & Connection Issues', icon: 'Wifi', color: 'blue-500' },
            // UPDATED: Icon changed from DollarSign to Nfc
            { id: 'stripe', name: 'Stripe Payment / Device Failures', icon: 'Nfc', color: 'indigo-500' }, 
            { id: 'display', name: 'Screen Display / Rotation Issues', icon: 'Monitor', color: 'teal-500' },
            { id: 'software', name: 'Software / Admin Screen / System Errors', icon: 'Settings', color: 'orange-500' },
            { id: 'hardware', name: 'Hardware / Module / Charging Issues', icon: 'Wrench', color: 'red-500' },
        ];

        function assignCategory(issue) {
            const lowerIssue = issue.toLowerCase();
            
            // --- CRITICAL FIX: Identify the two Stripe connection status issues
            const isNoStripeSign = lowerIssue.includes('no stripe sign visible in the upper left side');
            const isRedStripeSign = lowerIssue.includes('red stripe sign in the upper left side of the screen. there is no failure message');

            // --- PRIORITY 1: Explicitly route the two Stripe status issues to 'stripe' ---
            if (isNoStripeSign || isRedStripeSign) {
                return 'stripe';
            }

            // PRIORITY 2: Check for Display issues
            if (lowerIssue.includes('shows wrong screen or switches back and forth') || lowerIssue.includes('shows black screen while internet and stripe signs show correctly') || lowerIssue.includes('screen') || lowerIssue.includes('display') || lowerIssue.includes('upside down')) {
                return 'display';
            }

            // PRIORITY 3: Check for core Stripe issues (the rest)
            if (lowerIssue.includes('stripe') || lowerIssue.includes('readers') || lowerIssue.includes('pos') || lowerIssue.includes('usb disconnected') || lowerIssue.includes('merchant location id') || lowerIssue.includes('query device update')) {
                 return 'stripe';
            }
            
            // PRIORITY 4: Check for Network issues
            if (lowerIssue.includes('sim') || lowerIssue.includes('wifi') || lowerIssue.includes('network') || lowerIssue.includes('mobile network') || lowerIssue.includes('ofline') || lowerIssue.includes('connection')) return 'network';
            
            // PRIORITY 5: Check for Software issues
            if (lowerIssue.includes('admin screen') || lowerIssue.includes('revive') || lowerIssue.includes('factory restart') || lowerIssue.includes('incorrect access path') || lowerIssue.includes('register server')) return 'software';
            
            // PRIORITY 6: Check for Hardware issues
            if (lowerIssue.includes('powerbanks') || lowerIssue.includes('module') || lowerIssue.includes('lighting up')) return 'hardware';
            
            return 'software'; // Default fallback
        }

        const CATEGORIZED_ISSUES = ALL_ISSUES.reduce((acc, item) => {
            const catId = assignCategory(item.issue);
            if (!acc[catId]) acc[catId] = [];
            acc[catId].push(item);
            return acc;
        }, {});

        // --- State Management ---
        let currentScreen = 'categories'; // 'categories', 'issues', 'solution'
        let selectedCategory = null;
        let selectedIssue = null;
        const appElement = document.getElementById('content');
        let aiAnalysisResult = null; // Stores the generated AI text

        // --- Gemini API Handler ---
        window.handleGenerateAnalysis = async function() {
            const loadingElement = document.getElementById('aiAnalysis');
            const issueObj = CATEGORIZED_ISSUES[selectedCategory][selectedIssue];
            
            loadingElement.innerHTML = `
                <div class="flex items-center justify-center p-6 text-blue-600">
                    <div class="loading-animation mr-3"></div>
                    <span class="font-semibold">Gemini is generating analysis...</span>
                </div>
            `;
            
            const systemPrompt = "You are a Level 2 Technical Support Analyst for a cabinet charging station company. Your task is to analyze the user-reported issue and the recommended troubleshooting steps. Provide a concise, professional, and action-oriented response in two parts: 1. A brief summary of the root problem, and 2. A clear Escalation Note summarizing the most critical next step for field service technicians or remote support.";
            
            const userQuery = `Analyze the following technical report:\n\n---\nIssue: ${issueObj.issue}\n\nRecommended Steps: ${issueObj.solution}\n---\n\nBased on this, provide a concise summary and a clear, actionable escalation note.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (generatedText) {
                    aiAnalysisResult = generatedText;
                } else {
                    aiAnalysisResult = "Error: Could not generate analysis. The API returned an empty response.";
                }

            } catch (error) {
                console.error("Gemini API call failed:", error);
                aiAnalysisResult = "Error: Failed to connect to the analysis service. Please check your network connection or try again later.";
            }
            // Re-render the solution screen to display the result
            render(); 
        }

        // --- Rendering Functions ---

        function renderCategories() {
            let html = '<div class="space-y-4">';
            CATEGORIES.forEach(cat => {
                const count = (CATEGORIZED_ISSUES[cat.id] || []).length;
                
                // Now only using Lucide icons
                const iconHtml = `<i data-lucide="${cat.icon}" class="w-6 h-6 mr-3 text-${cat.color}"></i>`;

                html += `
                    <div id="cat-${cat.id}" data-id="${cat.id}" class="issue-card flex items-center justify-between p-4 bg-gray-50 rounded-xl cursor-pointer border border-gray-200 hover:border-gray-300" onclick="handleSelectCategory('${cat.id}')">
                        <div class="flex items-center">
                            ${iconHtml}
                            <div>
                                <h3 class="font-semibold text-gray-800">${cat.name}</h3>
                                <p class="text-sm text-gray-500">${count} potential issue${count !== 1 ? 's' : ''}</p>
                            </div>
                        </div>
                        <i data-lucide="ChevronRight" class="w-5 h-5 text-gray-400"></i>
                    </div>
                `;
            });
            html += '</div>';
            
            // ADDED: Start Over/Reset button to the Categories screen
            html += `
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <button class="w-full bg-red-50 text-red-700 py-3 rounded-xl font-semibold hover:bg-red-100 transition shadow-lg" onclick="handleReset()">Start Over</button>
                </div>
            `;

            appElement.innerHTML = html;
            
            // Re-render ALL necessary Lucide icons after adding HTML, including the category icons.
            if (window.createIcons && window.iconMap) {
                // Dynamically build the icons object needed for this screen
                const iconsToRender = {
                    ChevronRight: window.iconMap.ChevronRight
                };
                CATEGORIES.forEach(cat => {
                    iconsToRender[cat.icon] = window.iconMap[cat.icon];
                });

                window.createIcons({ icons: iconsToRender });
            }
        }

        function renderIssues() {
            const category = CATEGORIES.find(c => c.id === selectedCategory);
            const issues = CATEGORIZED_ISSUES[selectedCategory];

            let html = `
                <div class="mb-6">
                    <button class="flex items-center text-blue-600 hover:text-blue-800 font-medium text-sm transition" onclick="handleGoBack()">
                        <i data-lucide="ChevronLeft" class="w-4 h-4 mr-1"></i>
                        Back to Categories
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800 mt-2">${category.name}</h2>
                    <p class="text-gray-500">Select the exact issue description matching your screen.</p>
                </div>
                <div class="space-y-3">
            `;

            issues.forEach((item, index) => {
                html += `
                    <div data-index="${index}" class="issue-card flex items-start justify-between p-4 bg-white rounded-xl cursor-pointer border border-gray-200 hover:border-blue-300" onclick="handleSelectIssue(${index})">
                        <p class="text-gray-700 font-medium">${item.issue}</p>
                        <i data-lucide="ChevronRight" class="w-5 h-5 text-gray-400 ml-4 mt-1"></i>
                    </div>
                `;
            });

            html += '</div>';
            
            // ADDED: Start Over button to the Issues screen
            html += `
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <button class="w-full bg-red-50 text-red-700 py-3 rounded-xl font-semibold hover:bg-red-100 transition shadow-lg" onclick="handleReset()">Start Over</button>
                </div>
            `;
            
            appElement.innerHTML = html;
            
            // Call createIcons to render the Chevron icons.
            if (window.createIcons && window.iconMap) {
                window.createIcons({ icons: { ChevronRight: window.iconMap.ChevronRight, ChevronLeft: window.iconMap.ChevronLeft } });
            }
        }

        function renderSolution() {
            const issueObj = CATEGORIZED_ISSUES[selectedCategory][selectedIssue];

            // Convert raw solution text into a list of steps/options
            let solutionSteps = issueObj.solution.split(',').map(s => s.trim()).filter(s => s.length > 0);
            
            // Filter out empty strings and clean up the start of the strings
            let finalSteps = [];
            let currentStep = '';

            // Regex to match and remove prefixes: 'Option X)', 'X)', '-', 'The powerbanks...'
            // FIXED REGEX to prevent SyntaxError
            const prefixRegex = /^(Option\s+\d+|\d+)\)|\-\s*|(\s*The\s+powerbanks.*):?\s*/i;

            solutionSteps.forEach(step => {
                // Remove the option/numbering label from the start of the step if it exists
                let cleanedStep = step.replace(prefixRegex, '').trim();

                // Heuristic to detect the start of a new, distinct action/option
                if (step.match(/^(Option\s+\d+|\d+)\)|\-|\s*The\s+powerbanks/i) || finalSteps.length === 0) {
                    if (currentStep) {
                        finalSteps.push(currentStep);
                    }
                    currentStep = cleanedStep;
                } else {
                    currentStep += ' ' + cleanedStep;
                }
            });
            if (currentStep) {
                finalSteps.push(currentStep);
            }
            
            // Remove any initial empty string from consolidation logic
            if (finalSteps[0] === '' && finalSteps.length > 1) {
                finalSteps.shift();
            }

            // Simple cleaning: remove redundant commas and clean up spacing
            finalSteps = finalSteps.map(s => s.replace(/,(\s*Option)/g, '$1').trim()).filter(s => s.length > 0);


            let html = `
                <div class="mb-6">
                    <button class="flex items-center text-blue-600 hover:text-blue-800 font-medium text-sm transition" onclick="handleGoBack()">
                        <i data-lucide="ChevronLeft" class="w-4 h-4 mr-1"></i>
                        Back to Issues
                    </button>
                    <h2 class="text-2xl font-bold text-gray-800 mt-4">Troubleshooting Guide</h2>
                </div>

                <div class="bg-red-50 p-4 rounded-xl mb-6 border border-red-200">
                    <p class="text-red-700 font-semibold mb-2">Issue Detected:</p>
                    <p class="text-red-800 font-medium">${issueObj.issue}</p>
                </div>

                <div class="space-y-4">
                    <p class="font-semibold text-lg text-gray-700">Recommended Steps:</p>
                    <ul class="list-none space-y-3 pl-0">
                        ${finalSteps.map((step, index) => `
                            <li class="flex items-start bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                                <span class="flex-shrink-0 text-xl font-bold text-green-600 mr-3">${index + 1}.</span>
                                <p class="text-gray-700">${step}</p>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <!-- Gemini AI Analysis Section -->
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <p class="font-semibold text-lg text-gray-700 mb-3">AI Technical Analysis (Gemini)</p>
                    <div id="aiAnalysis" class="bg-gray-100 p-4 rounded-xl border border-gray-200 min-h-32 text-gray-700 whitespace-pre-wrap">
                        ${aiAnalysisResult ? `<p>${aiAnalysisResult}</p>` : `<p class="text-gray-500">Click the button below to generate a professional summary and escalation note for this issue.</p>`}
                    </div>
                    
                    <button class="w-full mt-4 bg-yellow-500 text-white py-3 rounded-xl font-semibold hover:bg-yellow-600 transition shadow-lg flex items-center justify-center" onclick="handleGenerateAnalysis()">
                        <i data-lucide="Loader" class="w-5 h-5 mr-2"></i>
                        ✨ Generate Detailed Analysis ✨
                    </button>
                </div>

                <!-- Start Over Button -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <button class="w-full bg-red-50 text-red-700 py-3 rounded-xl font-semibold hover:bg-red-100 transition shadow-lg" onclick="handleReset()">Start Over</button>
                </div>
            `;

            appElement.innerHTML = html;
            
            // Call createIcons to render the back button and Loader icon.
            if (window.createIcons && window.iconMap) {
                window.createIcons({ icons: { ChevronLeft: window.iconMap.ChevronLeft, Loader: window.iconMap.Loader } });
            }
        }

        // --- Controller/Event Handlers ---

        window.handleSelectCategory = function(id) {
            selectedCategory = id;
            currentScreen = 'issues';
            aiAnalysisResult = null; // Clear AI result on category change
            render();
        }

        window.handleSelectIssue = function(index) {
            selectedIssue = index;
            currentScreen = 'solution';
            aiAnalysisResult = null; // Clear AI result on issue change
            render();
        }

        window.handleGoBack = function() {
            if (currentScreen === 'solution') {
                currentScreen = 'issues';
            } else if (currentScreen === 'issues') {
                selectedCategory = null;
                currentScreen = 'categories';
            }
            aiAnalysisResult = null; // Clear AI result on back
            render();
        }

        window.handleReset = function() {
            selectedCategory = null;
            selectedIssue = null;
            currentScreen = 'categories';
            aiAnalysisResult = null; // Clear AI result on reset
            render();
        }

        function render() {
            if (currentScreen === 'categories') {
                renderCategories();
            } else if (currentScreen === 'issues') {
                renderIssues();
            } else if (currentScreen === 'solution') {
                renderSolution();
            }
        }

        // Initial render on load
        window.onload = function() {
            render();
        };

    </script>

</body>
</html>
